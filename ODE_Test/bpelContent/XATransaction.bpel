<!-- XATransaction BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Mon Apr 14 12:27:19 EEST 2014 -->
<bpel:process name="XATransaction"
         targetNamespace="http://bp.xa.transaction.ws.trix.com"
         suppressJoinFailure="yes"
         xmlns:tns="http://bp.xa.transaction.ws.trix.com"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"         
         xmlns:wsxa="http://javadb.xa.transaction.ws.trix.com"
         xmlns:xsd="http://www.w3.org/2001/XMLSchema"         
         >

    <!-- Import the client WSDL -->
	<bpel:import location="XATransactionArtifacts.wsdl"
	       namespace="http://bp.xa.transaction.ws.trix.com" 
	       importType="http://schemas.xmlsoap.org/wsdl/" />
  <bpel:import location="TransactionManagerWS.wsdl"
		     namespace="http://javadb.xa.transaction.ws.trix.com"
		     importType="http://schemas.xmlsoap.org/wsdl/"/>
         
    <!-- ================================================================= -->         
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->    
    <bpel:partnerLinks>
        <!-- The 'client' role represents the requester of this service. -->
        <bpel:partnerLink name="client"
                     partnerLinkType="tns:XATransaction"
                     myRole="XATransactionProvider"/>
        <bpel:partnerLink name="XATransactionWSLink"
            partnerLinkType="wsxa:XATransactionPLT"
            partnerRole="XATransactionRole"/>
    </bpel:partnerLinks>
  
    <!-- ================================================================= -->         
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->         
    <bpel:variables>        
        <bpel:variable name="input"
                  messageType="tns:XATransactionRequestMessage"/>
        <bpel:variable name="output"
                  messageType="tns:XATransactionResponseMessage"/>
        <bpel:variable name = "addOperationVariable"                  
                  messageType="wsxa:addOperationRequest"/>
        <bpel:variable name = "addOperationResponseVariable"                  
                  messageType="wsxa:addOperationResponse"/>
        <bpel:variable name = "commitVariable"                  
                  messageType="wsxa:commitRequest"/>
        <bpel:variable name = "commitResponseVariable"                  
                  messageType="wsxa:commitResponse"/>
        <bpel:variable name = "rollbackVariable"                  
                  messageType="wsxa:rollbackRequest"/>
        <bpel:variable name = "rollbackResponseVariable"                  
                  messageType="wsxa:rollbackResponse"/>
        <bpel:variable name="indexCycle" type="xsd:int"/>
        <bpel:variable name="gtrid" type="xsd:string"/>
        <bpel:variable name="bqual" type="xsd:string"/>
        <bpel:variable name="formatId" type="xsd:int"/>
    </bpel:variables>

    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
    <bpel:sequence name="main">       
        
        <bpel:receive name="receiveInput" partnerLink="client"
                 portType="tns:XATransaction"
                 operation="process" variable="input"
                 createInstance="yes"/>
                 
         <bpel:assign>
           <bpel:copy>
             <bpel:from><bpel:literal xml:space="preserve">0</bpel:literal></bpel:from>
             <bpel:to variable="indexCycle"/>
           </bpel:copy>
           <bpel:copy>
             <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">223</bpel:from>
             <bpel:to variable="gtrid"/>
           </bpel:copy>
           <bpel:copy>
             <bpel:from><bpel:literal xml:space="preserve">2</bpel:literal></bpel:from>
             <bpel:to variable="bqual"/>
           </bpel:copy>
           <bpel:copy>
             <bpel:from><bpel:literal xml:space="preserve">1</bpel:literal></bpel:from>
             <bpel:to variable="formatId"/>
           </bpel:copy>
         </bpel:assign>
         <!--          
        <bpel:scope name="TransactionScope">
          
           <bpel:faultHandlers>
             <bpel:catch faultName="wsxa:StringException" faultVariable="StringExceptionVariable"
               faultMessageType="wsxa:StringException">
                <bpel:sequence name="faultHandlerSequence">
               
                  <bpel:assign>
                    <bpel:copy>
                      <bpel:from variable="gtrid"/>
                      <bpel:to part="parameters" variable="rollbackVariable">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[wsxa:gtrid]]></bpel:query>
                      </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                      <bpel:from variable="bqual"/>
                      <bpel:to part="parameters" variable="rollbackVariable">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[wsxa:bqual]]></bpel:query>
                      </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                      <bpel:from variable="formatId"/>
                      <bpel:to part="parameters" variable="rollbackVariable">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[wsxa:formatId]]></bpel:query>
                      </bpel:to>
                    </bpel:copy>
                  </bpel:assign>
                    
                  <bpel:invoke name="InvokeRollback"
                    partnerLink="XATransactionWSLink"
                    operation="rollback"
                    portType="wsxa:TransactionManagerWS"
                    inputVariable="rollbackVariable"
                    outputVariable="rollbackResponseVariable"/>
                    
                  <bpel:assign>
			              <bpel:copy>
			                <bpel:from part="parameters" variable="rollbackResponseVariable">
			                  <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[wsxa:rollbackReturn]]></bpel:query>
			                </bpel:from>
			                <bpel:to part="payload" variable="output">
			                  <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:output]]></bpel:query>
			                </bpel:to>
			              </bpel:copy>    
			            </bpel:assign>
                 
                </bpel:sequence>
             </bpel:catch>
           </bpel:faultHandlers> 
        
          <bpel:sequence name="TransactionSequence">
                
		        <bpel:while name="Cycle">
		          <bpel:condition>3 != $indexCycle</bpel:condition>
		          <bpel:scope name="XACycleScope">
		            <bpel:sequence name="Update-Recive"> -->
		            
		              <bpel:assign validate="no" name="AssignIputToAddOperation">
		                <bpel:copy>
		                  <bpel:from variable="gtrid"/>
		                  <bpel:to part="parameters" variable="addOperationVariable">
		                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[wsxa:gtrid]]></bpel:query>
		                  </bpel:to>
		                </bpel:copy>
		                <bpel:copy>
		                  <bpel:from variable="bqual"/>
		                  <bpel:to part="parameters" variable="addOperationVariable">
		                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[wsxa:bqual]]></bpel:query>
		                  </bpel:to>
		                </bpel:copy>
		                <bpel:copy>
		                  <bpel:from variable="formatId"/>
		                  <bpel:to part="parameters" variable="addOperationVariable">
		                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[wsxa:formatId]]></bpel:query>
		                  </bpel:to>
		                </bpel:copy>
		                <bpel:copy>
		                    <bpel:from part="payload" variable="input">
		                      <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:input]]></bpel:query>                                          
		                    </bpel:from>
		                    <bpel:to part="parameters" variable="addOperationVariable">
		                      <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[wsxa:values]]></bpel:query>
		                    </bpel:to>
		                </bpel:copy>
		                <bpel:copy>
		                  <bpel:from>$indexCycle+1</bpel:from>
		                  <bpel:to variable="indexCycle"/>
		                </bpel:copy>
		                <bpel:copy>
		                 <bpel:from><bpel:literal>Inserted.</bpel:literal></bpel:from>
		                 <bpel:to part="payload" variable="output">
		                  <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:output]]></bpel:query>
		                 </bpel:to>
		               </bpel:copy>
		             </bpel:assign>

		             <bpel:if>
		               <bpel:condition>$indexCycle = 1</bpel:condition>
		                 <bpel:assign>
		                   <bpel:copy>
		                     <bpel:from><bpel:literal>0</bpel:literal></bpel:from>
		                     <bpel:to part="parameters" variable="addOperationVariable">
		                       <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[wsxa:startFlag]]></bpel:query>
		                     </bpel:to>
		                   </bpel:copy>
		                 </bpel:assign>
		                <bpel:else>
		                 <bpel:assign>
		                   <bpel:copy>
		                     <bpel:from><bpel:literal>2097152</bpel:literal></bpel:from>
		                     <bpel:to part="parameters" variable="addOperationVariable">
		                       <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[wsxa:startFlag]]></bpel:query>
		                     </bpel:to>
		                   </bpel:copy>
		                 </bpel:assign>
		                </bpel:else>
		              </bpel:if>

		              
		              <bpel:invoke name="InvokeAddOperation"
		                partnerLink="XATransactionWSLink"
		                operation="addOperation"
		                portType="wsxa:TransactionManagerWS"
		                inputVariable="addOperationVariable"
		                outputVariable="addOperationResponseVariable"/>
		                <!-- 
		              <bpel:reply name="replyCycle" 
		                partnerLink="client"
		                portType="tns:XATransaction"
		                operation="process"
		                variable="output"/>     
		              
		              <bpel:receive name="receiveCycle" partnerLink="client"
		                portType="tns:XATransaction"
		                operation="process"
		                variable="input"
		                createInstance="no"/>
		             
		            </bpel:sequence>
		          </bpel:scope>
		        </bpel:while> -->
		        
		        <bpel:assign>
		          <bpel:copy>          
		                  <bpel:from variable="gtrid"/>
		                  <bpel:to part="parameters" variable="commitVariable">
		                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[wsxa:gtrid]]></bpel:query>
		                  </bpel:to>
		                </bpel:copy>
		                <bpel:copy>
		                  <bpel:from variable="bqual"/>
		                  <bpel:to part="parameters" variable="commitVariable">
		                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[wsxa:bqual]]></bpel:query>
		                  </bpel:to>
		                </bpel:copy>
		                <bpel:copy>
		                  <bpel:from variable="formatId"/>
		                  <bpel:to part="parameters" variable="commitVariable">
		                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[wsxa:formatId]]></bpel:query>
		                  </bpel:to>
		          </bpel:copy>          
		        </bpel:assign>
		        
		        <bpel:invoke name="InvokeCommit"
		                partnerLink="XATransactionWSLink"
		                operation="commit"
		                portType="wsxa:TransactionManagerWS"
		                inputVariable="commitVariable"
		                outputVariable="commitResponseVariable"/>
		        
		        <bpel:assign>
		          <bpel:copy>
		            <bpel:from part="parameters" variable="commitResponseVariable">
		              <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[wsxa:commitReturn]]></bpel:query>
		            </bpel:from>
		            <bpel:to part="payload" variable="output">
		              <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:output]]></bpel:query>
		            </bpel:to>
		          </bpel:copy>    
		        </bpel:assign>
		        <!-- 
		      </bpel:sequence>
       
        </bpel:scope>
         -->
        <bpel:reply name="replyOutput" 
               partnerLink="client"
               portType="tns:XATransaction"
               operation="process" 
               variable="output"/>
               
    </bpel:sequence>
    
</bpel:process>

